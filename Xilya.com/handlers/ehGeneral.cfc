<!-----------------------------------------------------------------------Author 	 :	Luis MajanoDate     :	September 25, 2005Description : 				General handler for my hello application. Please remember to extend 	your event handler to the system eventhanlder using your colfusion	mapping.	example:		Mapping: fwsample		Argument Type: fwsample.system.eventhandlerModification History:Sep/25/2005 - Luis Majano	-Created the template.Oct/05/2005 - Luis Majano	- Added Extends to the system event handler.-----------------------------------------------------------------------><cfcomponent name="ehGeneral" extends="coldbox.system.eventhandler">	<!--- ************************************************************* --->	<cffunction name="init" access="public" returntype="any">		<cfset super.init()>		<cfreturn this>	</cffunction>	<!--- ************************************************************* --->	<!--- ************************************************************* --->	<cffunction name="onRequestStart" access="public">	</cffunction>	<!--- ************************************************************* --->	<!--- ************************************************************* --->	<cffunction name="onRequestEnd" access="public">	</cffunction>	<!--- ************************************************************* --->	<cffunction name="dspHome" access="public" returntype="string">			<!--- Process autologin (when user has clicked on remember me before) --->		<cfif isDefined("cookie.homeportals_username") and isDefined("cookie.homeportals_userKey") 				and cookie.homeportals_username neq ""				and cookie.homeportals_userKey neq "">			<cfset doCookieLogin(cookie.homeportals_username, cookie.homeportals_userKey)>		</cfif>			<cfset setView("vwHome")>	</cffunction>	<cffunction name="dspAbout" access="public" returntype="string">		<cfset setView("vwAbout")>	</cffunction>		<cffunction name="dspLogin" access="public" returntype="string">		<cfset setView("vwLogin")>	</cffunction>	<cffunction name="dspRegister" access="public" returntype="string">		<cfset setView("vwRegister")>	</cffunction>	<cffunction name="dspNoAccess" access="public" returntype="string">		<cfset setView("vwNoAccess")>	</cffunction>	<cffunction name="doCheckAccountName" access="public" returntype="string">		<cfscript>			var accountName = getValue("accountName","");			var oAccountsService = 0;			var qry = 0;					try {				if(accountName eq "") {					getPlugin("messagebox").setMessage("warning", "Please select a name for your workarea");					setNextEvent("ehGeneral.dspHome");				}									oAccountsService = getAccountsService();							// get info on requested user 				qry = oAccountsService.getAccountByUsername(accountName);							if(qry.recordCount gt 0) {					getPlugin("messagebox").setMessage("warning", "The workarea name you selected is already taken. Please select a different name");					setNextEvent("ehGeneral.dspHome");				} else {					setNextEvent("ehGeneral.dspRegister","accountName=#accountName#");				}						} catch(any e) {				getPlugin("messagebox").setMessage("error", e.message);				setNextEvent("ehGeneral.dspHome");			}		</cfscript>			</cffunction>	<cffunction name="doLogin" access="public" returntype="string">		<cfset var qryUser = QueryNew("")>		<cfset var oAccountsService = 0>		<cfset var accountName = getValue("accountName","")>		<cfset var password = getValue("password","")>		<cfset var rememberMe = getValue("rememberMe",0)>		<cfset var localSecret = getLocalSecret()>				<cftry>			<cfset oAccountsService = getAccountsService()>			<cfset qryUser = oAccountsService.loginUser(accountName,password)>						<cfif rememberMe eq 1>				<cfcookie name="homeportals_username" value="#qryUser.username#" expires="never">							<cfcookie name="homeportals_userKey" value="#Hash(localSecret)#" expires="never">						</cfif>						<cflocation url="/accounts/#qryUser.username#">			<cfcatch type="any">				<cfset getPlugin("messagebox").setMessage("error", cfcatch.message)>				<cfset setNextEvent("ehGeneral.dspLogin")>			</cfcatch>		</cftry>	</cffunction>	<cffunction name="doLogOff" access="public" returntype="void">		<cfset oAccountsService = getAccountsService()>		<cfset oAccountsService.logoutUser()>		<cfcookie name="homeportals_username" value="" expires="now">					<cfcookie name="homeportals_userKey" value="" expires="now">		<cfset setNextEvent("ehGeneral.dspHome")>	</cffunction>	<cffunction name="doRegister" access="public" returntype="string">		<cfscript>			var o = 0;			var accountID = 0;			var hpRoot = "/Home";			var accountName = getValue("accountName","");			var password = getValue("password","");			var password2 = getValue("password2","");			var email = getValue("email","");			var firstName = getValue("firstName","");			var lastName = getValue("lastName","");			var agree = getValue("agree",false);			var args = structNew();			var memberID = "";			var oAccountsService = 0;			try {				// validate form				if(accountName eq "") throw("The workarea cannot be empty. Please correct.");				if(reFind("[^A-Za-z0-9_]",accountName)) throw("The selected workarea name is invalid");				if(len(accountName) lt 5) throw("The workarea name must be at least 5 characters long");				if(email eq "") throw("Please enter your email address.");				if(reReplace(email,"^.+@[^\.].*\.[a-z]{2,}$","OK") neq "OK") throw("Please enter a valid email address.");				if(password eq "") throw("Password cannot be empty");				if(len(password) lt 6) throw("Passwords must be at least 6 characters long");				if(password neq password2) throw("The password confirmation does not match the selected passwords. Please correct.");				if(not agree) throw("You must agree to the terms and conditions before creating an account");								// create and initialize account object				oAccountsService = getAccountsService();									// create HomePortals account				accountID = oAccountsService.createAccount(accountName, password, email);										// crate and initialize members object				o = createObject("component","xilya.components.members");				o.init();					args.ID = "";				args.firstName = firstName;				args.middleName = "";				args.lastName = lastName;				args.email = email;				args.password = password;				args.type = "general";				args.accountID = accountID;				memberID = o.save(argumentCollection = args);				o.commit();								// send confirmation email				sendConfirmationEmail(accountName, args);								// login to account				doLogin();			} catch(any e) {				getPlugin("messagebox").setMessage("error", e.message);				setView("vwRegister");			}		</cfscript>	</cffunction>	<!---------------------------------------->	<!--- doCookieLogin        	           --->	<!---------------------------------------->		<cffunction name="doCookieLogin" access="public" output="true">		<cfargument name="username" type="string" required="yes">		<cfargument name="userkey" type="string" required="yes">		<cfset var realKey = "">		<cfset var qry = "">		<cfset var hpRoot = "/Home">		<cfset var oAccountsService = 0>		<cfset var localSecret = getLocalSecret()>		<cftry>			<cfset oAccountsService = getAccountsService()>						<!--- get info on requested user --->			<cfset qry = oAccountsService.getAccountByUsername(arguments.username)>			<!--- if user found, then authenticate user --->			<cfif qry.RecordCount gt 0>				<!--- build the real key that the user needs to authenticate --->				<cfset realKey = Hash(localSecret)>								<!--- if provided key is the same as the real key, then user is authenticated --->				<cfif arguments.userkey eq realkey>					<cfset qryUser = oAccountsService.loginUser(arguments.username, "", qry.password)>										<!--- take user to his homepage --->					<cflocation url="/Accounts/#qry.username#">				<cfelse>					<cfthrow message="Invalid key">				</cfif>			<cfelse>				<cfthrow message="Account not found">			</cfif>			<cfcatch type="any">				<cfset getPlugin("messagebox").setMessage("error", cfcatch.message)>				<cfset setNextEvent("ehGeneral.dspLogin")>			</cfcatch>		</cftry>	</cffunction>	<cffunction name="getLocalSecret" returntype="string">		<cfset var localSecret = "En su grave rincon, los jugadores "							& "rigen las lentas piezas. El tablero "							& "los demora hasta el alba en su severo "							& "ambito en que se odian dos colores. ">		<cfreturn localSecret>	</cffunction>	<cffunction name="sendConfirmationEmail" access="private" output="true">		<cfargument name="accountName" type="string" required="yes">		<cfargument name="memberStruct" type="struct" required="true">		<cfmail from="info@xilya.com" 				to="#arguments.memberStruct.email#"				subject="Welcome To Xilya.com"				type="html">			<p>			Hi #arguments.memberStruct.firstName#, welcome to 			<a href="http://www.xilya.com">Xilya.com</a>. Xilya is 			an experiment in personal online workspaces. It is currently under			active development so hiccups may happen from time to time. Please			do not hesitate to contact me at 			<a href="mailto:oarevalo@xilya.com">oarevalo@xilya.com</a> if you have			any questions or suggestions.			</p>			<p>				<b>Username:</b> #arguments.accountName#<br />				<b>Password:</b> #arguments.memberStruct.password#			</p>			<p>Oscar A.</p>		</cfmail>				<cfmail from="info@xilya.com" 				to="info@xilya.com"				subject="Xilya.com: New Registration"				type="html">							<b>New Registration Info:</b><br>						<table>				<tr><td><b>Account Name:</b></td><td>#arguments.accountName#</td></tr>				<tr><td><b>Account ID:</b></td><td>#arguments.memberStruct.accountID#</td></tr>				<tr><td><b>Email:</b></td><td>#arguments.memberStruct.email#</td></tr>				<tr><td><b>Name:</b></td><td>#arguments.memberStruct.firstName# #arguments.memberStruct.lastName#</td></tr>				<tr><td><b>Type:</b></td><td>#arguments.memberStruct.type#</td></tr>			</table>						</cfmail>	</cffunction>		<cffunction name="getAccountsService" returntype="Home.Components.accounts" access="package">		<cfscript>			var	configFilePath = "/xilya/config/homePortals-config.xml";			var oHomePortalsConfigBean = 0;			var oAccountsService  = 0;						oHomePortalsConfigBean = createObject("component", "Home.Components.homePortalsConfigBean").init(expandPath(configFilePath));			oAccountsService = CreateObject("component", "Home.Components.accounts").init(oHomePortalsConfigBean);			return oAccountsService;		</cfscript>		</cffunction>	</cfcomponent>